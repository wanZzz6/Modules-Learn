[qier222/YesPlayMusic: é«˜é¢œå€¼çš„ç¬¬ä¸‰æ–¹ç½‘æ˜“äº‘æ’­æ”¾å™¨ï¼Œæ”¯æŒ Windows / macOS / Linux](https://github.com/qier222/YesPlayMusic)

---

## ä¸€ã€å‡†å¤‡

### 1. å›æ»šç½‘æ˜“äº‘ç‰ˆæœ¬

[ç½‘æ˜“äº‘éŸ³ä¹ å†å²ç‰ˆæœ¬æ”¶é›†](https://blog.amarea.cn/archives/netease-cloudmusic-history-version.html)

2.10 ä»¥åçš„ç‰ˆæœ¬å¤±æ•ˆäº†ï¼Œ**å»ºè®®ç”¨2.9.6åŠä»¥å‰çš„ç‰ˆæœ¬**

å®‰è£…å®Œæˆåè®°å¾—åœ¨è®¾ç½® > å…³äºç½‘æ˜“äº‘éŸ³ä¹ > å–æ¶ˆæ‰è‡ªåŠ¨æ›´æ–°

ç›¸å…³åŸå› è§ï¼š[Issue #824](https://github.com/nondanee/UnblockNeteaseMusic/issues/824)

### 2. å®‰è£… Node.js

- Windows

  [Download | Node.js](https://nodejs.org/en/download/)
  ä¸‹è½½ .msi å®‰è£…åŒ…å¹¶å®‰è£…

- macOS

  [Download | Node.js](https://nodejs.org/en/download/)
  ä¸‹è½½ .pkg å®‰è£…åŒ…å¹¶å®‰è£…

- Linux

  [Installing Node.js via package manager | Node.js](https://nodejs.org/en/download/package-manager/)
  å‚ç…§æ•™ç¨‹å®‰è£… nodejs

### 3. ä¸‹è½½é¡¹ç›®æºç 
```sh
git clone https://github.com/UnblockNeteaseMusic/server.git UnblockNeteaseMusic
```

## äºŒã€å¯åŠ¨

### 1ã€æ–¹å¼ä¸€ï¼šæºç å¯åŠ¨

è¿›å…¥æºç ç›®å½•

```sh
cd UnblockNeteaseMusic
```

å®‰è£…ä¾èµ–

```sh
yarn config set nodeLinker node-modules
yarn install
```

#### æŸ¥çœ‹å‚æ•°è¯´æ˜

åœ¨ç»ˆç«¯è¾“å…¥

```sh
node app.js -h
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```sh
$ node app.js -h
usage: server [-v] [-p http[:https]] [-a address] [-u url] [-f host]
              [-o source [source ...]] [-t token] [-e url] [-s] [-c cnrelay]
              [-h]

optional arguments:
  -v, --version                   ç‰ˆæœ¬ä¿¡æ¯
  -p http[:https], --port http[:https]
                                  æŒ‡å®šæœåŠ¡ç«¯å£ï¼Œå¦‚ï¼š8080:8081
  -a address, --address address   æŒ‡å®šæœåŠ¡åœ°å€ï¼Œé»˜è®¤ï¼š0.0.0.0
  -u url, --proxy-url url         request through upstream proxy
  -f host, --force-host host      force the netease server ip
  -o source [source ...], --match-order source [source ...]
                                  è®¾ç½®éŸ³æº
  -t token, --token token         set up proxy authentication
  -e url, --endpoint url          replace virtual endpoint with public host
  -s, --strict                    enable proxy limitation
  -c cnrelay, --cnrelay cnrelay   Mainland China relay to get music url
  -h, --help                      output usage information
```

#### ä¸€èˆ¬ç”¨æ³•

ç”¨nodeå¯åŠ¨å…¥å£æ–‡ä»¶app.jsï¼Œå¹¶å›è½¦ã€‚æ³¨ï¼š-p ç”¨æ¥å‚æ•°æŒ‡å®šæœåŠ¡ç«¯å£ï¼Œæ­¤å¤„æˆ‘ä½¿ç”¨çš„æ˜¯54442å’Œ54443ï¼ˆä¸ªäººå–œå¥½ï¼‰ï¼Œåˆ†åˆ«ä¸ºhttpå’ŒhttpsæœåŠ¡ç«¯å£ï¼Œ

```sh
node app.js -p 54442:54443
```

ä¹Ÿå¯è®¾ç½®éŸ³æº
```sh
node app.js -p 54442:54443 -o kugou kuwo migu bilibili ytdlp
```



ä¸åŠ -oå‚æ•°é»˜è®¤å¯ç”¨çš„éŸ³æºï¼šé…·ç‹—ã€é…·æˆ‘ã€å’ªå’•ã€Youtubeã€Bç«™éŸ³ä¹

å…¶ä¸­ï¼ŒYoutube éœ€è¦é¢å¤–å®‰è£… ytdlp å·¥å…·ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚å¦‚æœä½ æœ‰Pythonç¯å¢ƒï¼Œå¯é€šè¿‡ `pip install yt-dlp` ä¸€é”®å®‰è£…

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šåŒæ—¶æŸ¥è¯¢æ‰€æœ‰æŒ‡å®šçš„éŸ³æºï¼Œé‚£ä¸ªå¹³å°**æœ€å…ˆå“åº”**æ•°æ®å°±å…ˆæ’­æ”¾å“ªä¸ªå¹³å°çš„ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹æ–‡è®¾ç½®ç¯å¢ƒå˜é‡`SELECT_MAX_BR=true`é€‰æ‹©æ’­æ”¾**æœ€é«˜ç ç‡**çš„å¹³å°ï¼Œæˆ–è€…`FOLLOW_SOURCE_ORDER=true`ä¸¥æ ¼æŒ‰ç…§ **-o å‚æ•°é…ç½®éŸ³æºçš„é¡ºåºè¿›è¡ŒæŸ¥è¯¢**ï¼Œå¦‚æœæ’­æ”¾çš„éŸ³é¢‘ä¸æ˜¯ä½ æƒ³è¦çš„ï¼Œå¯ä»¥å°è¯•ä¿®æ”¹éŸ³æºé¡ºåºï¼Œé€‰æ‹©ä¸€ä¸ªä½ å–œæ¬¢çš„éŸ³é¢‘ç‰ˆæœ¬ã€‚

>[éŸ³æºæ¸…å•](https://github.com/UnblockNeteaseMusic/server#%E9%9F%B3%E6%BA%90%E6%B8%85%E5%8D%95)

æ­£å¸¸ä¼šçœ‹åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š

```
INFO: (app) HTTP Server running @ http://0.0.0.0:54442
INFO: (app) HTTPS Server running @ http://0.0.0.0:54443
```

å¦‚æœæ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥è¯¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆ`netstat -ano | find "54442"`ï¼‰ï¼Œæˆ–è€…å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½å¯åŠ¨

```
node:events:491
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::54442
    at Server.setupListenHandle [as _listen2] (node:net:1740:16)
    at listenInCluster (node:net:1788:12)
    at Server.listen (node:net:1876:7)
    at E:\git_other\server\precompiled\app.js:81:154483
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1767:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -4091,
  syscall: 'listen',
  address: '::',
  port: 54442
}
```

>æ³¨ï¼šæ­¤é¡¹ç›®çš„æ—¥å¿—è¾“å‡ºä¾èµ– [pino](https://github.com/pinojs/pino) åº“ï¼Œæ—¥å¿—ç­‰çº§åœ¨debugæ—¶ï¼Œä¼šè¾“å‡ºå¤§é‡æ—¥å¿—ï¼Œåœ¨windowsç»ˆç«¯ä¸­è¾“å‡ºä¸­æ–‡ä¼šä¹±ç ï¼Œéœ€ç”¨ `chcp 65001` å‘½ä»¤ä¿®æ”¹ç»ˆç«¯ç¼–ç æ ¼å¼
>
>```sh
>chcp 65001 && node app.js -p 54442:54443
>```

### 2. æ–¹å¼äºŒï¼šæ³¨å†ŒæˆWindowsæœåŠ¡

æ ¹æ®è‡ªå·±éœ€è¦ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½•çš„ nw.js æ–‡ä»¶ï¼Œ`scriptOptions` æŒ‡å®šé™„åŠ å‚æ•°(-pç«¯å£ã€-oéŸ³æº)ï¼Œç¯å¢ƒå˜é‡å¯å‚è€ƒä¸‹æ–‡è¿›é˜¶ç”¨æ³•ï¼Œä¸å»ºè®®åœ¨ nw.js ä¸­ä¿®æ”¹`env`å‚æ•°ï¼Œå› ä¸ºåœ¨nw.jsä¸­åç»­æƒ³ä¿®æ”¹ç¯å¢ƒå˜é‡å¿…é¡»å¸è½½æœåŠ¡åé‡æ–°æ³¨å†ŒæœåŠ¡ã€‚

```sh
node ./nw.js
```

ä¼šå‡ºç°å¥½å‡ ä¸ªå¼¹æ¡†ï¼Œç‚¹å‡»ç¡®å®šå³å¯ã€‚å¦‚æœæœ‰å®‰å…¨ç®¡å®¶ç­‰è½¯ä»¶å¯èƒ½ä¼šé˜»æ­¢ï¼Œç›´æ¥å…è®¸å³å¯ã€‚è¿è¡ŒæˆåŠŸåå¯åœ¨ç”µè„‘æœåŠ¡ä¸­çœ‹åˆ°è¯¥æœåŠ¡ã€‚

>å¦‚æœæƒ³è¦å¸è½½å·²å®‰è£…çš„æœåŠ¡ï¼Œè¯·å†æ¬¡è¿è¡Œ `node ./nw.js`ã€‚
>
>å®‰è£…æœåŠ¡åï¼Œä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ `daemon` æ–‡ä»¶å¤¹ã€‚å¯åœ¨è¿™é‡ŒæŸ¥çœ‹æ—¥å¿—ã€‚
>
>å¦‚æœ**å®‰è£…ä¹‹å‰**ç›®å½•ä¸‹æœ‰ `daemon` æ–‡ä»¶å¤¹ï¼Œè¯·å…ˆæ‰‹åŠ¨åˆ é™¤ã€‚

### 3. æ–¹å¼ä¸‰ï¼špm2

ç±»ä¼¼äºDockerï¼Œè®©nodeç¨‹åºåœ¨åå°è¿è¡Œå¹¶ç›‘æ§è¿è¡ŒçŠ¶æ€

```sh
npm install -g pm2  # å®‰è£…pm2
pm2 start app.js -- -p 54442:54443   # å¯åŠ¨é¡¹ç›®

pm2 list  # æŸ¥çœ‹è¿è¡Œé¡¹ç›®
pm2 logs 0 # æŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼Œ0ä¸ºç¨‹åºid
pm2 stop all  # åœæ­¢æ‰€æœ‰è¿è¡Œé¡¹ç›®
pm2 startup  # pm2è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
```



### 4. è¿›é˜¶ç”¨æ³•-ç¯å¢ƒå˜é‡

ä¸€äº›é«˜çº§åŠŸèƒ½éœ€è¦é…åˆ**ç¯å¢ƒå˜é‡**ä½¿ç”¨ï¼Œæ¯”å¦‚å¼€å¯QQéŸ³ä¹éŸ³æºéœ€è¦å…ˆè®¾ç½® `QQ_COOKIE`ã€å±è”½éƒ¨åˆ†å¹¿å‘Šã€æ¿€æ´»æœ¬åœ°é»‘èƒ¶VIPç­‰åŠŸèƒ½ã€‚

ä½ å¯ä»¥æŸ¥çœ‹é¡¹ç›®æ”¯æŒçš„æ‰€æœ‰[ç¯å¢ƒå˜é‡](https://github.com/UnblockNeteaseMusic/server#ç¯å¢ƒå˜é‡)



ä¾‹å¦‚ï¼Œæˆ‘æƒ³å¼€å¯debugæ—¥å¿—ï¼ŒæŸ¥çœ‹æ­Œæ›²å…·ä½“æ¥è‡ªå“ªä¸ªå¹³å°ï¼Œä»¥åŠç¨‹åºè¿è¡Œæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œå°±éœ€è¦å°†æ—¥å¿—ç­‰çº§ç¯å¢ƒå˜é‡ `LOG_LEVEL`è®¾ç½®ä¸º `debug`ï¼Œå…·ä½“æ“ä½œï¼š

åœ¨é¡¹ç›® app.js çš„åŒçº§ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º `.env` çš„æ–‡ä»¶ï¼Œ

ç„¶åå†™å…¥:

```sh
LOG_LEVEL=debug
```

åœ¨ç¨‹åºæœ€å¼€å§‹å¯åŠ¨å°±è¦ä½¿å…¶åŠ è½½ç”Ÿæ•ˆï¼Œå…·ä½“è€Œè¨€ï¼Œå°±æ˜¯åœ¨ ./src/app.js ä»£ç æœ€ä¸Šæ–¹æ’å…¥ `require('dotenv').config()`

ä¿®æ”¹åçš„ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·ï¼š

*src/app.js* ï¼ˆæ³¨æ„ä¸æ˜¯é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ app.jsï¼‰

```js
console.log(require('dotenv').config())  // æ‰“å°ä¸€ä¸‹çœ‹æ˜¯å¦åŠ è½½æˆåŠŸ
const packageJson = require('../package.json');
const config = require('./cli.js')
	......
	......
```

å¦‚æœè¦æ³¨å†Œæˆç³»ç»ŸæœåŠ¡ï¼Œè¯·é‡æ–°buildé¡¹ç›®è®©ä¸Šè¿°ä»£ç ç”Ÿæ•ˆï¼Œåç»­ä¿®æ”¹ç¯å¢ƒå˜é‡ååªéœ€åœ¨ç³»ç»ŸæœåŠ¡ä¸Šå³é”®**é‡æ–°å¯åŠ¨**å³å¯ç”Ÿæ•ˆã€‚

```sh
yarn build
node ./nw.js
```

![image-20230708094229444](https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/win10%E8%A7%A3%E9%94%81%E7%BD%91%E6%98%93%E4%BA%91%E6%9C%8D%E5%8A%A1.png)



## ä»£ç†é…ç½®

PAC è‡ªåŠ¨ä»£ç†è„šæœ¬åœ°å€ `http://127.0.0.1:54442/proxy.pac`ï¼ˆåœ¨ä¸Šä¸€æ­¥æµ‹è¯•è¿è¡ŒæˆåŠŸåå¯ç”¨æµè§ˆå™¨æ‰“å¼€è¯¥åœ°å€ï¼Œæ³¨æ„è‡ªå·±è®¾ç½®çš„ç«¯å£ï¼‰

| å¹³å°    | åŸºç¡€è®¾ç½®                              |
| ------- | ------------------------------------- |
| Windows | è®¾ç½® > å·¥å…· > è‡ªå®šä¹‰ä»£ç† (å®¢æˆ·ç«¯å†…)   |
| UWP     | Windows è®¾ç½® > ç½‘ç»œå’Œ Internet > ä»£ç† |
| Linux   | ç³»ç»Ÿè®¾ç½® > ç½‘ç»œ > ç½‘ç»œä»£ç†            |
| macOS   | ç³»ç»Ÿåå¥½è®¾ç½® > ç½‘ç»œ > é«˜çº§ > ä»£ç†     |
| Android | WLAN > ä¿®æ”¹ç½‘ç»œ > é«˜çº§é€‰é¡¹ > ä»£ç†     |
| iOS     | æ— çº¿å±€åŸŸç½‘ > HTTP ä»£ç† > é…ç½®ä»£ç†     |



macOS çš„é…ç½®ï¼š

<img src="https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210131003610533.png" alt="image-20210131003610533" style="zoom: 67%;" />

## Macä¸‹httpsè¯ä¹¦é…ç½®

### å‡†å¤‡è¯ä¹¦æ–‡ä»¶

å¯ä»¥ç›´æ¥ä½¿ç”¨é¡¹ç›®æ–‡ä»¶ä¸­çš„ `server.crt` å’Œ `server.key`ï¼Œè‹¥éœ€è‡ªå·±ç­¾å‘è¯ä¹¦ï¼Œæ­¥éª¤å¦‚ä¸‹ (éœ€è¦ç”¨åˆ° OpenSSL)

```sh
# ç”Ÿæˆ CA ç§é’¥
openssl genrsa -out ca.key 2048

# ç”Ÿæˆ CA è¯ä¹¦ ("YOURNAME" å¤„å¡«ä¸Šä½ è‡ªå·±çš„åå­—)
openssl req -x509 -new -nodes -key ca.key -sha256 -days 1825 -out ca.crt -subj "/C=CN/CN=UnblockNeteaseMusic Root CA/O=YOURNAME"

# ç”ŸæˆæœåŠ¡å™¨ç§é’¥
openssl genrsa -out server.key 2048

# ç”Ÿæˆè¯ä¹¦ç­¾å‘è¯·æ±‚
openssl req -new -sha256 -key server.key -out server.csr -subj "/C=CN/L=Hangzhou/O=NetEase (Hangzhou) Network Co., Ltd/OU=IT Dept./CN=*.music.163.com"

# ä½¿ç”¨ CA ç­¾å‘æœåŠ¡å™¨è¯ä¹¦
openssl x509 -req -extfile <(printf "extendedKeyUsage=serverAuth\nsubjectAltName=DNS:music.163.com,DNS:*.music.163.com") -sha256 -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt
```

ä¸Šè¿°æ­¥éª¤å®Œæˆåï¼Œå½“å‰ç›®å½•ä¸‹å…±æ–°ç”Ÿæˆ6ä¸ªæ–‡ä»¶

```sh
$ ls
ca.crt		ca.srl		server.csr
ca.key		server.crt	server.key
```

**å°†æœåŠ¡å™¨ç§é’¥ (server.key) å’ŒæœåŠ¡å™¨è¯ä¹¦ (server.crt) æ‹·è´åˆ°ä»“åº“ä¸­è¦†ç›–åŸæœ‰æ–‡ä»¶** (è‹¥ä½¿ç”¨ dockerï¼Œå¯é€šè¿‡æ·»åŠ  `-v /path/to/server.crt:/usr/src/app/server.crt -v /path/to/server.key:/usr/src/app/server.key` å‚æ•°æ˜ å°„æœ¬åœ°è·¯å¾„è¦†ç›–åŸæœ‰æ–‡ä»¶)ï¼Œ**å†å°† CA è¯ä¹¦ (ca.crt) å®‰è£…åˆ°ç³»ç»Ÿï¼›**

å¦‚æœä¸è‡ªè¡Œç­¾å‘ï¼Œç›´æ¥å®‰è£…ä»“åº“é‡Œçš„ CA è¯ä¹¦ ([ca.crt](https://raw.githubusercontent.com/nondanee/UnblockNeteaseMusic/master/ca.crt)) ä¹Ÿå¯ã€‚

### å®‰è£…è¯ä¹¦

**CA è¯ä¹¦éœ€è¦æ‰‹åŠ¨é…ç½®ä¸ºä¿¡ä»»ï¼Œåˆ‡è®°**

Macç³»ç»Ÿç”¨ `safari` æ‰“å¼€ [music.163.com](https://music.163.com/) ï¼Œå®ƒä¼šæç¤ºä½ è¯ä¹¦é”™è¯¯ï¼Œç‚¹å‡» ã€Œè®¿é—®æ­¤ç½‘ç«™ã€åè¾“å…¥å¯†ç å®‰è£…è¯ä¹¦å³å¯

<img src="https://md-picture-1254350681.cos.ap-beijing.myqcloud.com/image-20210131002756430.png" alt="image-20210131002756430" style="zoom: 50%;" />

â€‹	(iOS ä¸Šå®¹æ˜“é—æ¼çš„æ­¥éª¤ ğŸ‘‰ https://support.apple.com/zh-cn/HT204477)

---

å…¶ä»–é…ç½®æ­¥éª¤è¯·å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼Œåå‘ä»£ç†ã€è®¾ç½®éŸ³æºç­‰ç­‰ã€‚

## ç›¸å…³é“¾æ¥

- [UnblockNeteaseMusic/server](https://github.com/UnblockNeteaseMusic/server)
- [UnblockNeteaseMusicï¼ˆåœæ­¢ç»´æŠ¤ï¼‰](https://github.com/nondanee/UnblockNeteaseMusic)
- [é£Ÿç”¨æŒ‡å—](https://github.com/nondanee/UnblockNeteaseMusic/issues/22)
- [è¿›é˜¶é…ç½®](https://github.com/nondanee/UnblockNeteaseMusic/issues/48)
- [other](https://github.com/nondanee/UnblockNeteaseMusic/issues/22#issuecomment-436505087)
- [å®‰è£ HTTPSè¯ä¹¦](https://github.com/UnblockNeteaseMusic/server/discussions/426)

